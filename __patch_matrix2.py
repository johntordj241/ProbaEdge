from pathlib import Path
import textwrap

path = Path('utils/predictions.py')
text = path.read_text()
needle = 'def _markets_from_matrix('
start = text.find(needle)
if start == -1:
    raise SystemExit('needle not found')
end = text.find('\n\ndef _betting_tips', start)
if end == -1:
    raise SystemExit('end marker not found')
old = text[start:end]
new_body = "def _markets_from_matrix(\n    matrix: Optional[List[List[float]]],\n    current_home: int,\n    current_away: int,\n) -> Dict[str, float]:\n    def _baseline_response() -> Dict[str, float]:\n        total_goals = current_home + current_away\n        base = {\n            \"home\": 1.0 if current_home > current_away else 0.0,\n            \"draw\": 1.0 if current_home == current_away else 0.0,\n            \"away\": 1.0 if current_home < current_away else 0.0,\n            \"over_0_5\": 1.0 if total_goals >= 1 else 0.0,\n            \"over_1_5\": 1.0 if total_goals >= 2 else 0.0,\n            \"over_2_5\": 1.0 if total_goals >= 3 else 0.0,\n            \"over_3_5\": 1.0 if total_goals >= 4 else 0.0,\n            \"btts_yes\": 1.0 if current_home > 0 and current_away > 0 else 0.0,\n            \"home_clean_sheet\": 1.0 if current_away == 0 else 0.0,\n            \"away_clean_sheet\": 1.0 if current_home == 0 else 0.0,\n            \"home_two_plus\": 1.0 if current_home >= 2 else 0.0,\n            \"away_two_plus\": 1.0 if current_away >= 2 else 0.0,\n            \"btts_over_2_5\": 1.0 if (current_home > 0 and current_away > 0 and total_goals >= 3) else 0.0,\n        }\n        base[\"btts_no\"] = 1.0 - base[\"btts_yes\"]\n        base[\"under_0_5\"] = 1.0 - base[\"over_0_5\"]\n        base[\"under_1_5\"] = 1.0 - base[\"over_1_5\"]\n        base[\"under_2_5\"] = 1.0 - base[\"over_2_5\"]\n        base[\"under_3_5\"] = 1.0 - base[\"over_3_5\"]\n        return base\n\n    if matrix is None:\n        return _baseline_response()\n\n    aggregates = {\n        \"home\": 0.0,\n        \"draw\": 0.0,\n        \"away\": 0.0,\n        \"over_0_5\": 0.0,\n        \"over_1_5\": 0.0,\n        \"over_2_5\": 0.0,\n        \"over_3_5\": 0.0,\n        \"btts_yes\": 0.0,\n        \"home_clean_sheet\": 0.0,\n        \"away_clean_sheet\": 0.0,\n        \"home_two_plus\": 0.0,\n        \"away_two_plus\": 0.0,\n        \"btts_over_2_5\": 0.0,\n    }\n    for i, row in enumerate(matrix):\n        for j, prob in enumerate(row):\n            final_home = current_home + i\n            final_away = current_away + j\n            total_goals = final_home + final_away\n            if final_home > final_away:\n                aggregates[\"home\"] += prob\n            elif final_home == final_away:\n                aggregates[\"draw\"] += prob\n            else:\n                aggregates[\"away\"] += prob\n            if total_goals >= 1:\n                aggregates[\"over_0_5\"] += prob\n            if total_goals >= 2:\n                aggregates[\"over_1_5\"] += prob\n            if total_goals >= 3:\n                aggregates[\"over_2_5\"] += prob\n            if total_goals >= 4:\n                aggregates[\"over_3_5\"] += prob\n            if final_home > 0 and final_away > 0:\n                aggregates[\"btts_yes\"] += prob\n                if total_goals >= 3:\n                    aggregates[\"btts_over_2_5\"] += prob\n            if final_away == 0:\n                aggregates[\"home_clean_sheet\"] += prob\n            if final_home == 0:\n                aggregates[\"away_clean_sheet\"] += prob\n            if final_home >= 2:\n                aggregates[\"home_two_plus\"] += prob\n            if final_away >= 2:\n                aggregates[\"away_two_plus\"] += prob\n\n    aggregates[\"btts_no\"] = 1.0 - aggregates[\"btts_yes\"]\n    aggregates[\"under_0_5\"] = 1.0 - aggregates[\"over_0_5\"]\n    aggregates[\"under_1_5\"] = 1.0 - aggregates[\"over_1_5\"]\n    aggregates[\"under_2_5\"] = 1.0 - aggregates[\"over_2_5\"]\n    aggregates[\"under_3_5\"] = 1.0 - aggregates[\"over_3_5\"]\n    return aggregates\n\n'''
path.write_text(text[:start] + new_body + text[end:])
